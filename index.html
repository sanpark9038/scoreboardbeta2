import React from 'react';

// Tailwind CSS 클래스와 함께 사용자 정의 CSS가 사용됩니다.

const THEMES = {
  terran: '#ffcc66',
  protoss: '#3bd6ff',
  zerg: '#622884',
};

const RACE_COLORS = {
  T: '#0779b3',
  P: '#e8cd04',
  Z: '#622884',
};

// localStorage 키 상수
const LINEUP_KEY = 'fs_lineup_v2';
const RHOME_KEY = 'fs_roster_home_v2';
const RAWAY_KEY = 'fs_roster_away_v2';
const ACTIVE_KEY = 'fs_active_slot_v2';
const OV_KEY = 'fs_overlay_urls_v1';
const ICON_KEY = 'fs_race_icons_v1';
const SNAP_KEY = 'fs_snapshots_v1';

// localStorage에서 JSON을 로드하고 저장하는 헬퍼 함수
const loadJSON = (key, def) => {
  try {
    const t = localStorage.getItem(key);
    return t ? JSON.parse(t) : def;
  } catch (e) {
    console.error(`localStorage에서 키 "${key}"를 로드하는 중 오류 발생:`, e);
    return def;
  }
};

const saveJSON = (key, val) => {
  try {
    localStorage.setItem(key, JSON.stringify(val));
  } catch (e) {
    console.error(`localStorage에 키 "${key}"를 저장하는 중 오류 발생:`, e);
  }
};

// Scoreboard 컴포넌트를 App 외부로 이동하고 state를 props로 받도록 수정
const Scoreboard = ({ state }) => {
    const { theme, c1, c2, overlays, w, series, sg, l1, l2, s1, s2, sets, lineup, activeSlot, rosterHome, rosterAway, icons, style } = state;
    const currentPair = lineup[activeSlot - 1] || { h: '', a: '', spL: '', spR: '' };
    const team1 = rosterHome.find(p => p.name === currentPair.h) || { name: currentPair.h, race: '' };
    const team2 = rosterAway.find(p => p.name === currentPair.a) || { name: currentPair.a, race: '' };

    const boardStyle = {
      '--accent': THEMES[theme],
      '--c1': c1,
      '--c2': c2,
      '--ov': overlays.opacity,
      minWidth: '520px',
      maxWidth: '960px',
      ...(w && { minWidth: 'unset', maxWidth: 'unset', width: /vw|%|px$/.test(w) ? w : `${w}px` }),
    };

    const team1NameRef = React.useRef(null);
    const team2NameRef = React.useRef(null);
    
    React.useEffect(() => {
      const checkOverflow = (ref) => {
        if (ref.current) {
          ref.current.style.fontSize = ''; // 폰트 크기 초기화
          const parentWidth = ref.current.parentElement.offsetWidth;
          let currentSize = parseFloat(getComputedStyle(ref.current).fontSize);
          while (ref.current.scrollWidth > parentWidth && currentSize > 10) {
            currentSize -= 1;
            ref.current.style.fontSize = `${currentSize}px`;
          }
        }
      };
      checkOverflow(team1NameRef);
      checkOverflow(team2NameRef);
    }, [team1.name, team2.name, w]);

    const normalizeSets = (s) => {
        if (!s) return [];
        return s.toUpperCase().replace(/\s+/g, '').split('').map(ch =>
          ch === 'L' || ch === '1' ? 'L' : (ch === 'R' || ch === '2' ? 'R' : null)
        ).filter(Boolean);
    };

    const getGlowClass = (glow) => {
        return `series-glow--${glow || 'strong'}`;
    };

    return (
      <>
      <style>
        {`
        .board{min-width:520px;max-width:960px;pointer-events:auto;position:relative;padding:10px 16px;border-radius:20px;display:flex;flex-direction:column;align-items:center; color:#e9f1ff; font-family:Segoe UI,Roboto,Helvetica,Arial,Apple SD Gothic Neo,Noto Sans KR,sans-serif;}
        .sc1{background:linear-gradient(180deg,rgba(0,0,0,.72),rgba(0,0,0,.46));border:1px solid rgba(59,214,255,.35);box-shadow:inset 0 0 0 1px rgba(59,214,255,.12),0 8px 22px rgba(0,0,0,.35);backdrop-filter:saturate(120%) blur(2px)}
        .clear{background:transparent;border:none;box-shadow:none;backdrop-filter:none}
        .solid{background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,.18);backdrop-filter:none}
        .glass{background:rgba(0,0,0,0.28);border:1px solid rgba(255,255,255,.15);backdrop-filter:saturate(140%) blur(6px)}
        .sc1:before,.sc1:after{content:"";position:absolute;height:3px;left:12px;right:12px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:.9;pointer-events:none}
        .sc1:before{top:4px}.sc1:after{bottom:4px}
        .wing{position:absolute;top:6px;bottom:6px;width:10px;pointer-events:none;filter:drop-shadow(0 2px 8px rgba(0,0,0,.6))}
        .wing.left{left:-8px;clip-path:polygon(0 0,100% 8px,100% calc(100% - 8px),0 100%)}
        .wing.right{right:-8px;clip-path:polygon(100% 0,0 8px,0 calc(100% - 8px),100% 100%)}
        .title .pill.series-glow--soft{ text-shadow:0 0 4px var(--accent, #3bd6ff),0 0 10px var(--accent, #3bd6ff))}
        .title .pill.series-glow--medium{ text-shadow:0 0 6px var(--accent, #3bd6ff),0 0 16px var(--accent, #3bd6ff))}
        .title .pill.series-glow--strong{ text-shadow:0 0 8px var(--accent, #3bd6ff),0 0 22px var(--accent, #3bd6ff))}
        .title .pill.series-glow--neon{ text-shadow:0 0 10px var(--accent, #3bd6ff),0 0 28px var(--accent, #3bd6ff),0 0 42px var(--accent, #3bd6ff))}
        .logo{border:1px solid; border-radius:10px;background:#0b0e12;position:relative;overflow:hidden;box-shadow:inset 0 0 10px rgba(59,214,255,.15)}
        .logo img { filter: brightness(1.75) contrast(1.1); } /* 로고 밝기 및 대비 조절 */
        .team{text-shadow:0 0 6px rgba(0,214,255,.25)}
        .vs:before{content:"";position:absolute;inset:0;border:1px solid rgba(59,214,255,.35);border-radius:6px;clip-path:polygon(8% 0,92% 0,100% 50%,92% 100%,8% 100%,0 50%);background:linear-gradient(180deg,rgba(59,214,255,.08),rgba(59,214,255,.02))}
        .num{background:linear-gradient(180deg,rgba(0,214,255,.18),rgba(0,214,255,.04));border:1px solid rgba(0,214,255,.38);box-shadow:inset 0 0 10px rgba(0,214,255,.25),0 2px 10px rgba(0,0,0,.35)}
        .dot{border:1px solid rgba(0,214,255,.45);background:rgba(0,214,255,.08)}
        .dot.on{background:rgba(0,214,255,.9)}
        .race-overlay{position:absolute;top:0;bottom:0;width:40%;opacity:var(--ov,0.12);filter:var(--ovFilter, none);mix-blend-mode:var(--ovBlend, normal);pointer-events:none;background-position:center;background-size:85% auto;background-repeat:no-repeat;z-index:1}
        .race-overlay.left{left:-4px}
        .race-overlay.right{right:-4px;transform:scaleX(-1)}
        .race-box {
          display:inline-flex; 
          align-items:center; 
          justify-content:center; 
          gap:8px; 
          padding: 5px 12px; 
          border-radius:999px; 
          background-color: rgba(15, 20, 30, 0.5);
          border: 1px solid rgba(255, 255, 255, 0.15);
          backdrop-filter: blur(4px);
          box-shadow: inset 0 0 8px rgba(0,0,0,.35);
        }
        .race-box span {
          font-size: 1.3rem;
          line-height: 1;
        }
        `}
      </style>
      <div className={`board ${style}`} style={boardStyle}>
        <i className="wing left" style={{ background: `linear-gradient(180deg, color-mix(in srgb,${c1} 85%,transparent), color-mix(in srgb,${c1} 35%,transparent))` }} aria-hidden="true"></i>
        <i className="wing right" style={{ background: `linear-gradient(180deg, color-mix(in srgb,${c2} 85%,transparent), color-mix(in srgb,${c2} 35%,transparent))` }} aria-hidden="true"></i>
        <div className="race-overlay left" style={{ backgroundImage: `url('${overlays[team1.race]}')`, mixBlendMode: overlays.mode.includes('screen') ? 'screen' : 'normal', filter: overlays.mode.includes('mono') ? 'grayscale(1) brightness(1.15)' : 'none' }} aria-hidden="true"></div>
        <div className="race-overlay right" style={{ backgroundImage: `url('${overlays[team2.race]}')`, mixBlendMode: overlays.mode.includes('screen') ? 'screen' : 'normal', filter: overlays.mode.includes('mono') ? 'grayscale(1) brightness(1.15)' : 'none' }} aria-hidden="true"></div>
        
        <div className="topbar w-full grid grid-cols-[1fr_auto_1fr] items-center mb-1.5 relative z-10">
          <div className="flex justify-start">
            {l1 && (
              <div className="logo w-14 h-14" style={{ borderColor: c1 }}>
                <img src={l1} alt="Logo 1" className="w-full h-full object-contain" />
              </div>
            )}
          </div>
          <div className="title text-xs uppercase font-semibold text-gray-400 tracking-widest flex items-center justify-center gap-2">
            <span className={`pill px-2 py-1 rounded-full border text-white text-2xl font-black bg-gradient-to-b from-blue-400/20 to-blue-400/10 shadow-inner shadow-blue-400/40 ${getGlowClass(sg)}`} style={{borderColor: 'var(--accent)'}}>
              {series}
            </span>
          </div>
          <div className="flex justify-end">
            {l2 && (
              <div className="logo w-14 h-14" style={{ borderColor: c2 }}>
                <img src={l2} alt="Logo 2" className="w-full h-full object-contain" />
              </div>
            )}
          </div>
        </div>

        <div className="scoreline w-full flex justify-center items-center gap-3 relative z-10">
          <div className="flex items-center justify-end gap-2 flex-1 min-w-0">
            <div ref={team1NameRef} className="team text-[1.625rem] font-black text-white whitespace-nowrap overflow-hidden text-ellipsis text-right">{team1.name}</div>
            <div className="race-box">
              <span className="font-bold" style={{color: RACE_COLORS[team1.race]}}>{team1.race}</span>
              {currentPair.spL && <span className="font-bold" style={{ color: c1 }}>{currentPair.spL}</span>}
            </div>
            {icons[team1.race] && (
              <img src={icons[team1.race]} alt={`${team1.race} icon`} className="w-5 h-5 opacity-95" />
            )}
          </div>
          <div className="num text-center text-[2rem] font-black text-white px-3 py-1 rounded-xl" style={{ border: `1px solid rgba(0,214,255,.38)` }}>
            {s1}
          </div>
          <div className="vs text-sm font-black uppercase text-gray-300 tracking-widest px-2 py-1 rounded-md">
            VS
          </div>
          <div className="num text-center text-[2rem] font-black text-white px-3 py-1 rounded-xl" style={{ border: `1px solid rgba(0,214,255,.38)` }}>
            {s2}
          </div>
          <div className="flex items-center justify-start gap-2 flex-1 min-w-0">
            {icons[team2.race] && (
              <img src={icons[team2.race]} alt={`${team2.race} icon`} className="w-5 h-5 opacity-95" />
            )}
            <div className="race-box">
              <span className="font-bold" style={{color: RACE_COLORS[team2.race]}}>{team2.race}</span>
              {currentPair.spR && <span className="font-bold" style={{ color: c2 }}>{currentPair.spR}</span>}
            </div>
            <div ref={team2NameRef} className="team text-[1.625rem] font-black text-white whitespace-nowrap overflow-hidden text-ellipsis text-left">{team2.name}</div>
          </div>
        </div>
        <div className="setsline w-full flex justify-between mt-1 relative z-10">
          <div className="dots flex gap-1.5">{normalizeSets(sets).map((ch, i) => <div key={i} className={`dot w-1.5 h-1.5 rounded-sm ${ch === 'L' ? 'on' : ''}`}></div>)}</div>
          <div className="dots flex gap-1.5">{normalizeSets(sets).map((ch, i) => <div key={i} className={`dot w-1.5 h-1.5 rounded-sm ${ch === 'R' ? 'on' : ''}`}></div>)}</div>
        </div>
      </div>
      </>
    );
};

// ControlPanel 컴포넌트를 App 컴포넌트 외부로 이동시켰습니다.
const ControlPanel = React.memo(({ isVisible, state, setState, setPanelOpen, generateCommentary, generatePrediction, isCallingGemini, commentary, prediction }) => {
    const [rosterHomeName, setRosterHomeName] = React.useState('');
    const [rosterAwayName, setRosterAwayName] = React.useState('');
    const [rosterHomeRace, setRosterHomeRace] = React.useState('T');
    const [rosterAwayRace, setRosterAwayRace] = React.useState('P');
    
    const [localSeries, setLocalSeries] = React.useState(state.series);
    React.useEffect(() => {
        setLocalSeries(state.series);
    }, [state.series]);

    const handleFilePicker = (callback) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => {
          const file = e.target.files?.[0];
          if (file) {
            callback(URL.createObjectURL(file));
          }
          input.remove();
        };
        input.click();
    };

    const handleAddPlayer = (side) => {
      const name = side === 'home' ? rosterHomeName.trim() : rosterAwayName.trim();
      const race = side === 'home' ? rosterHomeRace : rosterAwayRace;
      if (!name) return;
      
      const rosterKey = side === 'home' ? 'rosterHome' : 'rosterAway';
      const roster = state[rosterKey];
      if (roster.some(p => p.name === name)) return;
  
      setState(prevState => ({
        ...prevState,
        [rosterKey]: [...roster, { name, race }],
      }));
  
      side === 'home' ? setRosterHomeName('') : setRosterAwayName('');
    };
  
    const handleBulkClear = (side) => {
        setState(prevState => ({
            ...prevState,
            [side === 'home' ? 'rosterHome' : 'rosterAway']: [],
        }));
    };
    
    const applySlot = React.useCallback((slot) => {
        setState(prevState => ({ ...prevState, activeSlot: slot }));
    }, [setState]);

    const handleLineupChange = React.useCallback((slotIndex, side, name) => {
        setState(prevState => {
            const newLineup = prevState.lineup.map((slot, index) => 
                index === slotIndex ? { ...slot, [side]: name } : slot
            );
            return { ...prevState, lineup: newLineup };
        });
    }, [setState]);

    const handleClearLineupSlot = React.useCallback((slotIndex) => {
        setState(prevState => {
            const newLineup = prevState.lineup.map((slot, index) => 
                index === slotIndex ? { ...slot, h: '', a: '' } : slot
            );
            return { ...prevState, lineup: newLineup };
        });
    }, [setState]);

    const handleSpClick = React.useCallback((side, value) => {
        const slotIndex = state.activeSlot - 1;
        setState(prevState => {
            const newLineup = prevState.lineup.map((slot, index) => {
                if (index === slotIndex) {
                    const newSp = slot[side] === value ? '' : value;
                    return { ...slot, [side]: newSp };
                }
                return slot;
            });
            return { ...prevState, lineup: newLineup };
        });
    }, [state.activeSlot, setState]);

    return (
      <div 
        className="fixed top-4 right-4 z-[2147483647] bg-gray-900/95 border border-white/10 rounded-xl shadow-2xl backdrop-blur-md p-4 min-w-[640px] text-white max-h-[calc(100vh-32px)] overflow-auto resize transition-opacity duration-300"
        style={{
            opacity: isVisible ? 1 : 0,
            pointerEvents: isVisible ? 'auto' : 'none',
        }}
      >
        <h3 className="text-xs uppercase font-semibold text-gray-400 tracking-widest sticky top-0 bg-gray-900/95 z-10 py-1 flex justify-center">
          Overlay Controls
          <button
            className="absolute top-1/2 -translate-y-1/2 right-3 w-7 h-7 flex items-center justify-center border border-gray-700 rounded-md bg-gray-800 text-white cursor-pointer hover:border-blue-400"
            onClick={() => setPanelOpen(false)}
          >
            ✕
          </button>
        </h3>
        {/* Series & Style Controls */}
        <div className="grid grid-cols-[160px_1fr] gap-2 items-center my-1.5">
          <label>타이틀</label>
          <input
            className="bg-gray-800 border border-gray-700 text-white p-2 rounded-md"
            value={localSeries}
            onChange={(e) => setLocalSeries(e.target.value)}
            onBlur={() => setState(prevState => ({...prevState, series: localSeries}))}
          />
        </div>
        <div className="grid grid-cols-[160px_1fr] gap-2 items-center my-1.5">
          <label>Series Glow</label>
          <select
            className="bg-gray-800 border border-gray-700 text-white p-2 rounded-md"
            value={state.sg}
            onChange={(e) => setState(prevState => ({ ...prevState, sg: e.target.value }))}
          >
            <option value="soft">Soft</option>
            <option value="medium">Medium</option>
            <option value="strong">Strong</option>
            <option value="neon">Neon</option>
          </select>
        </div>
        <div className="grid grid-cols-[160px_1fr] gap-2 items-center my-1.5">
          <label>좌/우 색</label>
          <div className="flex gap-2">
            <input 
              type="color" 
              className="p-1 rounded-md" 
              value={state.c1} 
              onInput={(e) => setState(prevState => ({ ...prevState, c1: e.target.value }))} 
            />
            <input 
              type="color" 
              className="p-1 rounded-md" 
              value={state.c2} 
              onInput={(e) => setState(prevState => ({ ...prevState, c2: e.target.value }))} 
            />
          </div>
        </div>
        <div className="grid grid-cols-[160px_1fr] gap-2 items-center my-1.5">
          <label>Style</label>
          <select
            className="bg-gray-800 border border-gray-700 text-white p-2 rounded-md"
            value={state.style}
            onChange={(e) => setState(prevState => ({ ...prevState, style: e.target.value }))}
          >
            <option value="sc1">sc1</option>
            <option value="clear">clear</option>
            <option value="glass">glass</option>
            <option value="solid">solid</option>
          </select>
        </div>
        <div className="grid grid-cols-[160px_1fr] gap-2 items-center my-1.5">
          <label>Width</label>
          <input
            className="bg-gray-800 border border-gray-700 text-white p-2 rounded-md"
            placeholder="880 or 50vw"
            value={state.w}
            onChange={(e) => setState(prevState => ({ ...prevState, w: e.target.value }))}
          />
        </div>
        <div className="grid grid-cols-[160px_1fr] gap-2 items-center my-1.5">
          <label>Top</label>
          <input
            className="bg-gray-800 border border-gray-700 text-white p-2 rounded-md"
            placeholder="20 or 4vh"
            value={state.y}
            onChange={(e) => setState(prevState => ({ ...prevState, y: e.target.value }))}
          />
        </div>

        {/* Roster Controls */}
        <h3 className="text-xs uppercase font-semibold text-gray-400 tracking-widest my-4">로스터 빠른 추가</h3>
        <div className="grid grid-cols-[160px_1fr] gap-2 items-center my-1.5">
          <label>우리팀 추가</label>
          <div className="flex gap-2 items-center">
            <input
              id="add_h_name"
              placeholder="이름"
              className="bg-gray-800 border border-gray-700 text-white p-2 rounded-md min-w-[160px]"
              value={rosterHomeName}
              onChange={(e) => setRosterHomeName(e.target.value)}
              onKeyDown={(e) => { if (e.key === 'Enter') handleAddPlayer('home'); }}
            />
            <div className="flex gap-1">
              {['T', 'P', 'Z'].map(race => (
                <button
                  key={race}
                  className={`px-2 py-1 rounded-md font-bold text-gray-400 border border-gray-700 ${rosterHomeRace === race ? 'bg-blue-400 text-gray-900 border-blue-400' : ''}`}
                  onClick={() => setRosterHomeRace(race)}
                >
                  {race}
                </button>
              ))}
            </div>
            <button className="btn bg-blue-400 text-gray-900 font-bold px-3 py-2 rounded-md" onClick={() => handleAddPlayer('home')}>추가</button>
          </div>
        </div>
        <div className="grid grid-cols-[160px_1fr] gap-2 items-center my-1.5">
          <label>상대팀 추가</label>
          <div className="flex gap-2 items-center">
            <input
              id="add_a_name"
              placeholder="이름"
              className="bg-gray-800 border border-gray-700 text-white p-2 rounded-md min-w-[160px]"
              value={rosterAwayName}
              onChange={(e) => setRosterAwayName(e.target.value)}
              onKeyDown={(e) => { if (e.key === 'Enter') handleAddPlayer('away'); }}
            />
            <div className="flex gap-1">
              {['T', 'P', 'Z'].map(race => (
                <button
                  key={race}
                  className={`px-2 py-1 rounded-md font-bold text-gray-400 border border-gray-700 ${rosterAwayRace === race ? 'bg-blue-400 text-gray-900 border-blue-400' : ''}`}
                  onClick={() => setRosterAwayRace(race)}
                >
                  {race}
                </button>
              ))}
            </div>
            <button className="btn bg-blue-400 text-gray-900 font-bold px-3 py-2 rounded-md" onClick={() => handleAddPlayer('away')}>추가</button>
          </div>
        </div>
        <div className="grid grid-cols-[160px_1fr] gap-2 items-center my-1.5">
            <label>일괄삭제</label>
            <div className="flex gap-2">
                <button className="btn danger bg-red-800 text-red-200 font-bold px-3 py-2 rounded-md" onClick={() => handleBulkClear('home')}>우리팀 전체삭제</button>
                <button className="btn danger bg-red-800 text-red-200 font-bold px-3 py-2 rounded-md" onClick={() => handleBulkClear('away')}>상대팀 전체삭제</button>
            </div>
        </div>

        {/* Lineup Controls */}
        <h3 className="text-xs uppercase font-semibold text-gray-400 tracking-widest my-4">라인업 (1–9)</h3>
        <div className="grid grid-cols-[160px_1fr] gap-2 items-center my-1.5">
          <label>활성 슬롯</label>
          <div className="flex gap-2 items-center">
            <select
              id="active_slot"
              className="bg-gray-800 border border-gray-700 text-white p-2 rounded-md"
              value={state.activeSlot}
              onChange={(e) => applySlot(parseInt(e.target.value, 10))}
            >
              {Array.from({ length: 9 }, (_, i) => (
                <option key={i} value={i + 1}>{i + 1}</option>
              ))}
            </select>
            <button className="btn bg-gray-800 border border-gray-700 text-white p-2 rounded-md" onClick={() => applySlot(Math.max(1, state.activeSlot - 1))}>◀ 이전</button>
            <button className="btn bg-gray-800 border border-gray-700 text-white p-2 rounded-md" onClick={() => applySlot(Math.min(9, state.activeSlot + 1))}>다음 ▶</button>
          </div>
        </div>
        <div className="grid grid-cols-[160px_1fr] gap-2 items-center my-1.5">
          <label>SP(좌/우)</label>
          <div className="flex gap-2 items-center">
            {['1', '5', '7', '11'].map(sp => (
              <button key={`spL-${sp}`} className={`miniBtn px-2 py-1 rounded-md text-sm border ${state.lineup[state.activeSlot - 1]?.spL === sp ? 'bg-blue-400 text-gray-900' : 'bg-gray-800 text-white border-gray-700'}`} onClick={() => handleSpClick('spL', sp)}>L:{sp}</button>
            ))}
            <span className="w-3"></span>
            {['1', '5', '7', '11'].map(sp => (
              <button key={`spR-${sp}`} className={`miniBtn px-2 py-1 rounded-md text-sm border ${state.lineup[state.activeSlot - 1]?.spR === sp ? 'bg-blue-400 text-gray-900' : 'bg-gray-800 text-white border-gray-700'}`} onClick={() => handleSpClick('spR', sp)}>R:{sp}</button>
            ))}
          </div>
        </div>
        <div className="lineup border border-gray-700 rounded-md p-1 my-2 max-h-64 overflow-auto">
          {state.lineup.map((pair, index) => (
            <div key={index} className="grid grid-cols-[28px_1fr_24px_1fr_auto_auto] gap-1 items-center p-1 border-b border-gray-700 last:border-b-0">
              <span className="text-center opacity-75">{index + 1}</span>
              <select
                className="bg-gray-800 border border-gray-700 text-white p-1 rounded-md text-sm"
                value={pair.h || ''}
                onChange={(e) => handleLineupChange(index, 'h', e.target.value)}
              >
                <option value="">-</option>
                {state.rosterHome.map((p, i) => (
                  <option key={i} value={p.name}>{p.name} ({p.race})</option>
                ))}
              </select>
              <span className="text-center opacity-70 text-sm">vs</span>
              <select
                className="bg-gray-800 border border-gray-700 text-white p-1 rounded-md text-sm"
                value={pair.a || ''}
                onChange={(e) => handleLineupChange(index, 'a', e.target.value)}
              >
                <option value="">-</option>
                {state.rosterAway.map((p, i) => (
                  <option key={i} value={p.name}>{p.name} ({p.race})</option>
                ))}
              </select>
              <button className="miniBtn px-2 py-1 rounded-md text-xs bg-gray-800 border border-gray-700 text-white" onClick={() => applySlot(index + 1)}>적용</button>
              <button className="miniBtn px-2 py-1 rounded-md text-xs bg-gray-800 border border-gray-700 text-white" onClick={() => handleClearLineupSlot(index)}>지움</button>
            </div>
          ))}
        </div>

        {/* Score / Sets Controls */}
        <h3 className="text-xs uppercase font-semibold text-gray-400 tracking-widest my-4">스코어 / 세트</h3>
        <div className="grid grid-cols-[160px_1fr] gap-2 items-center my-1.5">
          <label>Score 1</label>
          <div className="flex gap-2 items-center">
            <button className="btn bg-gray-800 border border-gray-700 text-white p-2 rounded-md" onClick={() => setState(prevState => ({ ...prevState, s1: Math.max(0, prevState.s1 - 1) }))}>-</button>
            <input
              type="number" min="0"
              className="w-[70px] bg-gray-800 border border-gray-700 text-white p-2 rounded-md"
              value={state.s1}
              onChange={(e) => setState(prevState => ({ ...prevState, s1: parseInt(e.target.value, 10) || 0 }))}
            />
            <button className="btn bg-gray-800 border border-gray-700 text-white p-2 rounded-md" onClick={() => setState(prevState => ({ ...prevState, s1: prevState.s1 + 1 }))}>+</button>
          </div>
        </div>
        <div className="grid grid-cols-[160px_1fr] gap-2 items-center my-1.5">
          <label>Score 2</label>
          <div className="flex gap-2 items-center">
            <button className="btn bg-gray-800 border border-gray-700 text-white p-2 rounded-md" onClick={() => setState(prevState => ({ ...prevState, s2: Math.max(0, prevState.s2 - 1) }))}>-</button>
            <input
              type="number" min="0"
              className="w-[70px] bg-gray-800 border border-gray-700 text-white p-2 rounded-md"
              value={state.s2}
              onChange={(e) => setState(prevState => ({ ...prevState, s2: parseInt(e.target.value, 10) || 0 }))}
            />
            <button className="btn bg-gray-800 border border-gray-700 text-white p-2 rounded-md" onClick={() => setState(prevState => ({ ...prevState, s2: prevState.s2 + 1 }))}>+</button>
          </div>
        </div>
        <div className="grid grid-cols-[160px_1fr] gap-2 items-center my-1.5">
          <label>SETS (L/R)</label>
          <div className="flex gap-2 items-center">
            <input
              id="i_sets"
              placeholder="예: LRRLL"
              className="flex-1 bg-gray-800 border border-gray-700 text-white p-2 rounded-md"
              value={state.sets}
              onChange={(e) => setState(prevState => ({ ...prevState, sets: e.target.value }))}
            />
            <button className="btn bg-gray-800 border border-gray-700 text-white p-2 rounded-md" onClick={() => setState(prevState => ({ ...prevState, sets: prevState.sets + 'L' }))}>L</button>
            <button className="btn bg-gray-800 border border-gray-700 text-white p-2 rounded-md" onClick={() => setState(prevState => ({ ...prevState, sets: prevState.sets + 'R' }))}>R</button>
            <button className="btn bg-gray-800 border border-gray-700 text-white p-2 rounded-md" onClick={() => setState(prevState => ({ ...prevState, sets: prevState.sets.slice(0, -1) }))}>⌫</button>
            <button className="btn bg-gray-800 border border-gray-700 text-white p-2 rounded-md" onClick={() => setState(prevState => ({ ...prevState, sets: '' }))}>Clear</button>
          </div>
        </div>

        {/* Overlays and Icons */}
        <h3 className="text-xs uppercase font-semibold text-gray-400 tracking-widest my-4">종족 오버레이 (T/P/Z)</h3>
        {['T', 'P', 'Z'].map(race => (
          <div key={`ov-${race}`} className="grid grid-cols-[160px_1fr] gap-2 items-center my-1.5">
            <label>{race} 오버레이</label>
            <div className="flex gap-2 items-center">
              <input
                className="flex-1 bg-gray-800 border border-gray-700 text-white p-2 rounded-md"
                placeholder="URL"
                value={state.overlays[race] || ''}
                onChange={(e) => setState(prevState => ({ ...prevState, overlays: { ...prevState.overlays, [race]: e.target.value } }))}
              />
              <button className="btn bg-gray-800 border border-gray-700 text-white p-2 rounded-md" onClick={() => handleFilePicker(url => setState(prevState => ({ ...prevState, overlays: { ...prevState.overlays, [race]: url } })))}>파일</button>
              <button className="btn bg-gray-800 border border-gray-700 text-white p-2 rounded-md" onClick={() => setState(prevState => ({ ...prevState, overlays: { ...prevState.overlays, [race]: '' } }))}>Clear</button>
            </div>
          </div>
        ))}
        <div className="grid grid-cols-[160px_1fr] gap-2 items-center my-1.5">
          <label>오버레이 투명도</label>
          <input
            type="range" min="0" max="1" step="0.01"
            value={state.overlays.opacity}
            onChange={(e) => setState(prevState => ({ ...prevState, overlays: { ...prevState.overlays, opacity: parseFloat(e.target.value) }}))}
          />
        </div>
        <div className="grid grid-cols-[160px_1fr] gap-2 items-center my-1.5">
          <label>오버레이 모드</label>
          <select
            className="bg-gray-800 border border-gray-700 text-white p-2 rounded-md"
            value={state.overlays.mode}
            onChange={(e) => setState(prevState => ({ ...prevState, overlays: { ...prevState.overlays, mode: e.target.value } }))}
          >
            <option value="color">원본색</option>
            <option value="screen-color">스크린(컬러)</option>
            <option value="screen-mono">스크린(모노)</option>
          </select>
        </div>
        <h3 className="text-xs uppercase font-semibold text-gray-400 tracking-widest my-4">종족 아이콘 (T/P/Z)</h3>
        {['T', 'P', 'Z'].map(race => (
          <div key={`ic-${race}`} className="grid grid-cols-[160px_1fr] gap-2 items-center my-1.5">
            <label>{race} 아이콘</label>
            <div className="flex gap-2 items-center">
              <input
                className="flex-1 bg-gray-800 border border-gray-700 text-white p-2 rounded-md"
                placeholder="URL"
                value={state.icons[race] || ''}
                onChange={(e) => setState(prevState => ({ ...prevState, icons: { ...prevState.icons, [race]: e.target.value } }))}
              />
              <button className="btn bg-gray-800 border border-gray-700 text-white p-2 rounded-md" onClick={() => handleFilePicker(url => setState(prevState => ({ ...prevState, icons: { ...prevState.icons, [race]: url } })))}>파일</button>
              <button className="btn bg-gray-800 border border-gray-700 text-white p-2 rounded-md" onClick={() => setState(prevState => ({ ...prevState, icons: { ...prevState.icons, [race]: '' } }))}>Clear</button>
            </div>
          </div>
        ))}

        {/* Team Logos */}
        <h3 className="text-xs uppercase font-semibold text-gray-400 tracking-widest my-4">팀 로고 (좌/우)</h3>
        <div className="grid grid-cols-[160px_1fr] gap-2 items-center my-1.5">
          <label>좌 로고</label>
          <div className="flex gap-2 items-center">
            <input
              className="flex-1 bg-gray-800 border border-gray-700 text-white p-2 rounded-md"
              placeholder="URL"
              value={state.l1}
              onChange={(e) => setState(prevState => ({ ...prevState, l1: e.target.value }))}
            />
            <button className="btn bg-gray-800 border border-gray-700 text-white p-2 rounded-md" onClick={() => handleFilePicker(url => setState(prevState => ({ ...prevState, l1: url })))}>파일</button>
            <button className="btn bg-gray-800 border border-gray-700 text-white p-2 rounded-md" onClick={() => setState(prevState => ({ ...prevState, l1: '' }))}>Clear</button>
          </div>
        </div>
        <div className="grid grid-cols-[160px_1fr] gap-2 items-center my-1.5">
          <label>우 로고</label>
          <div className="flex gap-2 items-center">
            <input
              className="flex-1 bg-gray-800 border border-gray-700 text-white p-2 rounded-md"
              placeholder="URL"
              value={state.l2}
              onChange={(e) => setState(prevState => ({ ...prevState, l2: e.target.value }))}
            />
            <button className="btn bg-gray-800 border border-gray-700 text-white p-2 rounded-md" onClick={() => handleFilePicker(url => setState(prevState => ({ ...prevState, l2: url })))}>파일</button>
            <button className="btn bg-gray-800 border border-gray-700 text-white p-2 rounded-md" onClick={() => setState(prevState => ({ ...prevState, l2: '' }))}>Clear</button>
          </div>
        </div>
        <div className="mt-4 pt-4 border-t border-gray-700">
            <div className="flex gap-2 items-center">
                <button 
                    className={`px-3 py-1 rounded-full text-white font-bold transition-all duration-200 ease-in-out ${isCallingGemini ? 'bg-gray-500 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'}`}
                    onClick={generateCommentary}
                    disabled={isCallingGemini}
                >
                    AI 해설자 ✨
                </button>
                <div className="text-sm text-gray-300 flex-1 min-w-0">{commentary}</div>
            </div>
        </div>
        <div className="mt-2 pt-2 border-t border-gray-700">
            <div className="flex gap-2 items-center">
                <button
                    className={`px-3 py-1 rounded-full text-white font-bold transition-all duration-200 ease-in-out ${isCallingGemini ? 'bg-gray-500 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}
                    onClick={generatePrediction}
                    disabled={isCallingGemini}
                >
                    AI 승자 예측 ✨
                </button>
                <div className="text-sm text-gray-300 flex-1 min-w-0">{prediction}</div>
            </div>
        </div>

      </div>
    );
});

// 메인 앱 컴포넌트
export default function App() {
  const [panelOpen, setPanelOpen] = React.useState(false);
  const [isAdmin, setIsAdmin] = React.useState(false);
  const [isClearMode, setIsClearMode] = React.useState(false);
  const [state, setState] = React.useState({
    theme: 'protoss',
    style: 'sc1',
    series: 'Bo5',
    sg: 'strong',
    c1: '#e35a5a',
    c2: '#3bd6ff',
    s1: 0,
    s2: 0,
    sets: '',
    l1: '',
    l2: '',
    w: '',
    y: '',
    rosterHome: [],
    rosterAway: [],
    lineup: Array.from({ length: 9 }, () => ({ h: '', a: '', spL: '', spR: '' })),
    activeSlot: 1,
    overlays: { T: '', P: '', Z: '', opacity: 0.12, mode: 'color' },
    icons: { T: '', P: '', Z: '' },
    scale: 1,
  });
  const [commentary, setCommentary] = React.useState("AI 해설자가 경기를 기다리고 있습니다.");
  const [prediction, setPrediction] = React.useState("AI가 경기 예측을 준비 중입니다.");
  const [isCallingGemini, setIsCallingGemini] = React.useState(false);

  // 최초 렌더링 시 localStorage에서 상태 로드 및 관리자/OBS 모드 확인
  React.useEffect(() => {
    const qs = new URLSearchParams(window.location.search);
    if (qs.get('admin') === 'true') {
      setIsAdmin(true);
      setPanelOpen(true);
    }
    
    if (qs.get('style') === 'clear') {
      setIsClearMode(true);
    }

    const snaps = loadJSON(SNAP_KEY, {});
    const baseState = snaps.base || {};
    const lineup = loadJSON(LINEUP_KEY, Array.from({ length: 9 }, () => ({ h: '', a: '', spL: '', spR: '' })));
    const rosterHome = loadJSON(RHOME_KEY, []);
    const rosterAway = loadJSON(RAWAY_KEY, []);
    const activeSlot = parseInt(localStorage.getItem(ACTIVE_KEY) || '1', 10);
    const overlays = loadJSON(OV_KEY, { T: '', P: '', Z: '', opacity: 0.12, mode: 'color' });
    const icons = loadJSON(ICON_KEY, { T: '', P: '', Z: '' });
    
    const queryTheme = qs.get('theme') || 'protoss';
    const queryStyle = qs.get('style') || 'sc1';
    const queryW = qs.get('w') || '';
    const queryY = qs.get('y') || '';
    const queryScale = parseFloat(qs.get('scale') || '1');
    const querySeries = qs.get('series') || 'Bo5';
    const querySG = qs.get('sg') || 'strong';
    
    document.documentElement.style.setProperty('--accent', THEMES[queryTheme] || THEMES.protoss);

    setState(prevState => ({
      ...prevState,
      ...baseState,
      rosterHome,
      rosterAway,
      lineup,
      activeSlot,
      overlays,
      icons,
      theme: queryTheme,
      style: queryStyle,
      w: queryW,
      y: queryY,
      scale: queryScale,
      series: querySeries,
      sg: querySG,
    }));
  }, []);

  // 상태 변경 시 localStorage에 동기화
  React.useEffect(() => {
    saveJSON(LINEUP_KEY, state.lineup);
    saveJSON(RHOME_KEY, state.rosterHome);
    saveJSON(RAWAY_KEY, state.rosterAway);
    localStorage.setItem(ACTIVE_KEY, String(state.activeSlot));
    saveJSON(OV_KEY, state.overlays);
    saveJSON(ICON_KEY, state.icons);
  }, [state]);

  // Gemini API 호출 함수
  const callGemini = async (prompt) => {
    setIsCallingGemini(true);
    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
    const apiKey = "";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

    let attempt = 0;
    const maxRetries = 5;
    while (attempt < maxRetries) {
      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          throw new Error(`API 호출 실패: ${response.status}`);
        }
        const result = await response.json();
        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (text) {
          setIsCallingGemini(false);
          return text;
        } else {
          throw new Error('API 응답 구조가 올바르지 않습니다.');
        }
      } catch (error) {
        console.error(`Gemini API 호출 오류 (시도 ${attempt + 1}):`, error);
        attempt++;
        if (attempt >= maxRetries) {
          setIsCallingGemini(false);
          return 'Gemini API 호출에 실패했습니다. 다시 시도해 주세요.';
        }
        const delay = Math.pow(2, attempt) * 1000;
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  };
  
  const currentPair = state.lineup[state.activeSlot - 1] || { h: '', a: '', spL: '', spR: '' };
  const team1 = state.rosterHome.find(p => p.name === currentPair.h) || { name: currentPair.h, race: '' };
  const team2 = state.rosterAway.find(p => p.name === currentPair.a) || { name: currentPair.a, race: '' };

  // AI 해설 생성
  const generateCommentary = async () => {
    setCommentary("AI 해설자가 생각 중입니다...");
    const team1Name = team1.name || '왼쪽 선수';
    const team2Name = team2.name || '오른쪽 선수';
    const prompt = `현재 Freekshot e-sports 경기 스코어보드 상황입니다.
- 경기 시리즈: ${state.series}
- 왼쪽 선수: ${team1Name} (종족: ${team1.race || '미정'}, SP: ${currentPair.spL || '없음'})
- 오른쪽 선수: ${team2Name} (종족: ${team2.race || '미정'}, SP: ${currentPair.spR || '없음'})
- 현재 스코어: ${state.s1} 대 ${state.s2}
- 세트 결과 (L=왼쪽 승, R=오른쪽 승): ${state.sets.length > 0 ? state.sets.split('').join(', ') : '없음'}
이 상황에 대해, 전문 e-sports 스포츠 해설가처럼 흥미진진하고 박진감 넘치는 짧은 해설을 한국어로 70자 내외로 작성해주세요.`;
    const result = await callGemini(prompt);
    setCommentary(result);
  };
  
  // AI 승자 예측 생성
  const generatePrediction = async () => {
    setPrediction("AI가 예측 중입니다...");
    const team1Name = team1.name || '왼쪽 선수';
    const team2Name = team2.name || '오른쪽 선수';
    const prompt = `Freekshot e-sports 게임의 다음 경기 승자를 예측해주세요.
- 왼쪽 선수: ${team1Name} (종족: ${team1.race || '미정'}, SP: ${currentPair.spL || '없음'})
- 오른쪽 선수: ${team2Name} (종족: ${team2.race || '미정'}, SP: ${currentPair.spR || '없음'})
- 현재 스코어: ${state.s1} 대 ${state.s2}
- 세트 결과 (L=왼쪽 승, R=오른쪽 승): ${state.sets.length > 0 ? state.sets.split('').join(', ') : '없음'}
이 정보를 바탕으로, 다음 라운드의 승자가 누구일지, 그리고 그 핵심적인 이유를 한국어로 70자 내외로 예측해주세요.`;
    const result = await callGemini(prompt);
    setPrediction(result);
  };

  return (
    <>
      {isClearMode && (
        <style>{`
          body, html {
            background-color: transparent !important;
          }
        `}</style>
      )}
      <div className={`font-sans text-white ${isClearMode ? '' : 'bg-gray-900 min-h-screen p-8 flex flex-col items-center justify-center'}`}>
        <div className="fixed" style={{top: state.y || '20px', left: '50%', transform: `translateX(-50%) scale(${state.scale || 1})`, transformOrigin: 'top center'}}>
          <Scoreboard state={state} />
        </div>

        {isAdmin && (
          <button
            className="fixed top-4 right-4 z-[2147483650] w-9 h-9 rounded-full bg-blue-400 text-gray-900 font-bold flex items-center justify-center border-none shadow-lg cursor-pointer"
            onClick={() => setPanelOpen(!panelOpen)}
          >
            ⚙
          </button>
        )}

        <ControlPanel 
          isVisible={isAdmin && panelOpen}
          state={state} 
          setState={setState} 
          setPanelOpen={setPanelOpen}
          generateCommentary={generateCommentary}
          generatePrediction={generatePrediction}
          isCallingGemini={isCallingGemini}
          commentary={commentary}
          prediction={prediction}
        />
      </div>
    </>
  );
}
